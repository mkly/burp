<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, minimal-ui">
<link rel="stylesheet" href="//yui.yahooapis.com/pure/0.4.2/pure-min.css">
<script type="text/javascript" src="gif.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/socket.io/0.9.16/socket.io.min.js"></script>
<script type="text/javascript" src="//cdnjs.cloudflare.com/ajax/libs/underscore.js/1.6.0/underscore-min.js"></script>

<style>
#webcam, #result, #canvas {
  height: 120px;
  width: 160px;

}
#webcam {
  -webkit-transform: scale(-1, 1);
  -moz-transform: scale(-1, 1);
  -ms-transform: scale(-1, 1);
  transform: scale(-1, 1);
  float: right;
  -webkit-border-top-right-radius: 4px;
  -webkit-border-bottom-right-radius: 4px;
  -moz-border-radius-topright: 4px;
  -moz-border-radius-bottomright: 4px;
  border-top-right-radius: 4px;
  border-bottom-right-radius: 4px;
}
#canvas {
  display: none;
}
#result {
  display: block;
  float: left;
  -webkit-border-top-right-radius: 4px;
  -webkit-border-bottom-right-radius: 4px;
  -moz-border-radius-topright: 4px;
  -moz-border-radius-bottomright: 4px;
  border-top-right-radius: 4px;
  border-bottom-right-radius: 4px;
}
#snap {
  margin: 15px auto;
  display: block
}
.pure-button {
  background: #e60;
  color: #fff;
}
.lighten {
  opacity: 0.5;
}
</style>

</head>

<body>

<div style="margin-top: 15px">
<div class="pure-g">
  <div class="pure-u-1-2">
    <video class="lighten" id="webcam"></video>
    <canvas id="canvas"></canvas>
  </div>
  <div class="pure-u-1-2">
    <img id="result" src="blank.png"/>
  </div>
  <div class="pure-u-1-1">
    <button id="snap" class="pure-button">Snap</button>
  </div>
</div>
<div class="pure-g">
	<div class="pure-u-1">
		<ul id="images"></ul>
	</div>
</div>
</div>

<script type="html/template" id="images-template">
<% _.each(images, function(img) { %>
	<li><img src="<%= img %>" /></li>
<% }); %>
</script>

<script type="text/javascript">
+function(window, document) { "use strict";

navigator.getUserMedia = navigator.getUserMedia || navigator.webkitGetUserMedia || navigator.mozGetUserMedia || navigator.msGetUserMedia
window.URL = window.URL || window.webkitURL || window.mozURL || window.msURL

var video = document.getElementById("webcam"),
    snapBtn = document.getElementById("snap"),
    canvas = document.getElementById("canvas"),
    ctx = canvas.getContext("2d"),
    result = document.getElementById("result"),
    width = 160,
    height = 120,
    imagesContainer = document.getElementById("images"),
    images = [],
    socket = io.connect(),
    imagesTemplate = _.template(document.getElementById("images-template").innerHTML);

if (!navigator.getUserMedia) {
  console.log("Camera Not Supported")
  return;
}



socket.on('buuur added', function(data) {
	images.unshift(data.img);
	while (images.length > 10) {
		images.pop();
	}
	imagesContainer.innerHTML = imagesTemplate({images: images});
});

navigator.getUserMedia({video: true}, successCallback, errorCallback)

function successCallback(stream) {
  if (video.mozSrcObject !== undefined) {
    video.mozSrcObject = stream;
  } else {
    video.src = (window.URL && window.URL.createObjectURL(stream)) || stream
  }
}

function errorCallback() {}

var xhr = new XMLHttpRequest;
xhr.open('GET', '/images', true);
xhr.onload = function() {
  if (xhr.status == 200) {
    images = JSON.parse(xhr.responseText);
    imagesContainer.innerHTML = imagesTemplate({images: images})
  }
};
xhr.send();

+function init() {

  canvas.height = height
  canvas.width = width
  ctx.translate(width, 0)
  ctx.scale(-1, 1)

  snapBtn.onclick = function() {

    snapBtn.disabled = true
    video.className = ""
    result.className = "lighten"

    var gif = new GIF({
          workers: 2,
          quality: 3,
          height: height,
          width: width
        }),
        numFrames = 8,
        interval = window.setInterval(function() {
          if (numFrames < 1) {
            window.clearInterval(interval)
            gif.render()
            video.className = "lighten"
            return
          }
          numFrames -= 1
          ctx.drawImage(video, 0, 0, width, height)
          gif.addFrame(ctx, {copy: true, delay: 100})
        }, 340),
        oldblob

    gif.on("finished", function(blob) {
			var reader = new FileReader();
			reader.onload = function(e) {
				result.src = reader.result;
				socket.emit('add buuur', {img: reader.result});
			}
			reader.readAsDataURL(blob);
      window.URL.revokeObjectURL(oldblob)
      oldblob = blob
      result.className = ""
      snapBtn.disabled = false
    })

  }

  video.play()

}()

}(window, document)

</script>

</body>
</html>
